<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Tester</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #f8f9fa; }
        h1, h2 { color: #212529; }
        .container { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        input[type="text"], select { width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        button { background-color: #007bff; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #results { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef; }
        #status { font-style: italic; color: #6c757d; }
        .metrics { background: #e9f5ff; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .metrics p { margin: 0.5rem 0; }
        .metrics strong { min-width: 100px; display: inline-block; }
        #screenshot { max-width: 100%; border: 1px solid #dee2e6; border-radius: 4px; margin-top: 1rem; }
        .rules-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef; }
        .rule-options { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 0.75rem; }
        .rule-options fieldset { border: 1px solid #dee2e6; border-radius: 4px; padding: 0.5rem 1rem; }
        .rule-options legend { font-weight: 600; font-size: 0.9em; padding: 0 0.5em; }
        .rule-options label { display: block; font-weight: normal; margin-bottom: 0.25rem; }
        .rules-section h2 { margin-top: 0; }
        .rule-group { display: flex; gap: 1rem; }
        .error { color: #dc3545; font-weight: bold; }
        .preset-actions { margin-top: 1rem; }
        .preset-actions fieldset { border: 1px solid #dee2e6; border-radius: 4px; padding: 0.75rem 1rem; }
        .preset-actions legend { font-weight: 600; font-size: 0.9em; padding: 0 0.5em; }
        .preset-actions button {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.375rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            margin-right: 0.5rem;
        }
        .preset-actions button:hover { background-color: #dee2e6; border-color: #b1b9c1; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Performance Tester</h1>

        <div class="form-group">
            <label for="url-select">Select a predefined site or choose 'Custom'</label>
            <select id="url-select">
                <option value="https://www.theguardian.com/">The Guardian https://www.theguardian.com/</option>
                <option value="https://plaxidityx.com/">PlaxidityX https://plaxidityx.com/</option>
                <option value="https://example.com/">Example.com https://example.com/</option>
                <option value="custom" selected>Custom URL</option>
            </select>
        </div>

        <div class="form-group" id="custom-url-group" style="display: block;">
            <label for="url-input">Enter Custom URL</label>
            <input type="text" id="url-input" placeholder="https://your-site.com">
        </div>

        <div class="form-group">
            <label for="mode-select">Test Mode</label>
            <select id="mode-select">
                <option value="pagespeed-mobile">PageSpeed Mobile</option>
                <option value="pagespeed-desktop">PageSpeed Desktop</option>
                <option value="custom" selected>Custom (Default)</option>
            </select>
        </div>

        <div class="rules-section">
            <h2>Advanced Rules (Optional)</h2>
            <div class="form-group">
                <label for="block-rules">Block Resources</label>
                <div class="rule-options" id="block-rule-options">
                    <fieldset>
                        <legend>Analytics</legend>
                        <label><input type="checkbox" value="googletagmanager.com"> googletagmanager.com</label>
                        <label><input type="checkbox" value="google-analytics.com"> google-analytics.com</label>
                    </fieldset>
                    <fieldset>
                        <legend>Ads</legend>
                        <label><input type="checkbox" value="doubleclick.net"> doubleclick.net</label>
                        <label><input type="checkbox" value="googlesyndication.com"> googlesyndication.com</label>
                    </fieldset>
                    <fieldset>
                        <legend>Common Types</legend>
                        <label><input type="checkbox" value=".png,.jpg,.jpeg,.gif,.svg,.webp"> All Images</label>
                        <label><input type="checkbox" value="fonts.googleapis.com,.woff2,.ttf"> Fonts</label>
                        <label><input type="checkbox" value=".css"> All CSS</label>
                    </fieldset>
                    <fieldset>
                        <legend>Libs & 3rd Parties</legend>
                        <label><input type="checkbox" value="jquery.js,jquery.min.js"> jQuery</label>
                        <label><input type="checkbox" value="jquery-migrate"> jQuery Migrate</label>
                        <label><input type="checkbox" value="cookiebot.com,uc.js"> Cookiebot</label>
                    </fieldset>
                </div>
                <input type="text" id="block-rules" placeholder="e.g., googletagmanager, .css">
                <small style="color: #6c757d;">Select presets or enter comma-separated URL fragments to block.</small>
            </div>
            <div class="form-group">
                <label for="defer-rules">Defer Scripts</label>
                <div class="rule-options" id="defer-rule-options">
                    <fieldset>
                        <legend>Analytics</legend>
                        <label><input type="checkbox" value="googletagmanager.com"> googletagmanager.com</label>
                        <label><input type="checkbox" value="google-analytics.com"> google-analytics.com</label>
                    </fieldset>
                    <fieldset>
                        <legend>Ads</legend>
                        <label><input type="checkbox" value="doubleclick.net"> doubleclick.net</label>
                        <label><input type="checkbox" value="googlesyndication.com"> googlesyndication.com</label>
                    </fieldset>
                    <fieldset>
                        <legend>Widgets</legend>
                        <label><input type="checkbox" value="intercom.io"> intercom.io</label>
                        <label><input type="checkbox" value="livechatinc.com"> livechatinc.com</label>
                        <label><input type="checkbox" value="connect.facebook.net"> connect.facebook.net</label>
                        <label><input type="checkbox" value="platform.twitter.com"> platform.twitter.com</label>
                    </fieldset>
                    <fieldset>
                        <legend>Libs & 3rd Parties</legend>
                        <label><input type="checkbox" value="jquery.js,jquery.min.js"> jQuery</label>
                        <label><input type="checkbox" value="jquery-migrate"> jQuery Migrate</label>
                        <label><input type="checkbox" value="cookiebot.com,uc.js"> Cookiebot</label>
                    </fieldset>
                </div>
                <input type="text" id="defer-rules" placeholder="e.g., analytics.js, chat-widget.js">
                <small style="color: #6c757d;">Select presets or enter comma-separated script URL fragments to defer.</small>
            </div>
            <div class="form-group">
                <label>Replace HTML Content</label>
                <div class="rule-group">
                    <input type="text" id="html-find-rule" placeholder="Find (supports regex)">
                    <input type="text" id="html-replace-rule" placeholder="Replace with">
                </div>
                <small style="color: #6c757d;">The 'Find' field is treated as a global regular expression. For example, to remove all `<img>` tags, use `&lt;img[^>]*&gt;` in 'Find' and leave 'Replace' empty.</small>
                <div class="preset-actions" id="html-replace-presets">
                    <fieldset>
                        <legend>WP Rocket Presets</legend>
                        <!-- Note: Quotes within data attributes are HTML-escaped as &quot; -->
                        <button type="button" data-find="media='print' onload=&quot;this.media='all'&quot;" data-replace="media='all'">Disable RUCSS</button>
                        <button type="button" data-find="type=&quot;text/rocketscript&quot;" data-replace="type=&quot;text/javascript&quot;">Disable JS Delay</button>
                        <button type="button" data-find="&lt;iframe([^&gt;]*)data-src=&quot;([^&quot;]+)&quot;" data-replace="&lt;iframe$1src=&quot;$2&quot;">Disable iFrame LazyLoad</button>
                        <button type="button" data-find="&lt;style id=&quot;wpr-usedcss&quot;&gt;[^&lt;]*&lt;/style&gt;" data-replace="">Remove Used CSS Block</button>
                    </fieldset>
                </div>
            </div>
        </div>

        <button id="run-test">Run Test</button>

        <div id="results">
            <h2>Results</h2>
            <p id="status">Awaiting test...</p>
            <div id="metrics-container" style="display: none;"></div>
            <img id="screenshot" style="display: none;" />
        </div>
    </div>

    <script>
        const urlSelect = document.getElementById('url-select');
        const customUrlGroup = document.getElementById('custom-url-group');
        const urlInput = document.getElementById('url-input');
        const modeSelect = document.getElementById('mode-select');
        const blockRulesInput = document.getElementById('block-rules');
        const deferRulesInput = document.getElementById('defer-rules');
        const htmlFindInput = document.getElementById('html-find-rule');
        const htmlReplaceInput = document.getElementById('html-replace-rule');
        const runTestBtn = document.getElementById('run-test');
        const statusEl = document.getElementById('status');
        const metricsContainer = document.getElementById('metrics-container');
        const screenshotEl = document.getElementById('screenshot');
        const blockRuleOptions = document.getElementById('block-rule-options');
        const deferRuleOptions = document.getElementById('defer-rule-options');
        const htmlReplacePresets = document.getElementById('html-replace-presets');

        urlSelect.addEventListener('change', () => {
            if (urlSelect.value === 'custom') {
                customUrlGroup.style.display = 'block';
            } else {
                customUrlGroup.style.display = 'none';
            }
        });

        // --- Rule Preset Logic ---
        function updateRulesFromCheckboxes(optionsContainer, inputElement) {
            const checkedOptions = Array.from(optionsContainer.querySelectorAll('input:checked'));
            const presetValues = new Set();

            // Get all values from checked boxes. A value can be a comma-separated list.
            checkedOptions.forEach(checkbox => {
                checkbox.value.split(',').forEach(val => {
                    if (val.trim()) presetValues.add(val.trim());
                });
            });

            // Get all currently known preset values to help identify custom ones.
            const allPresetValues = new Set();
            optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.value.split(',').forEach(val => {
                    if (val.trim()) allPresetValues.add(val.trim());
                });
            });

            // Preserve custom values that the user may have typed manually.
            const currentInputValues = inputElement.value.split(',').map(s => s.trim()).filter(Boolean);
            const customValues = currentInputValues.filter(val => !allPresetValues.has(val));

            const finalValues = new Set([...presetValues, ...customValues]);
            inputElement.value = Array.from(finalValues).join(', ');
        }

        blockRuleOptions.addEventListener('change', () => updateRulesFromCheckboxes(blockRuleOptions, blockRulesInput));
        deferRuleOptions.addEventListener('change', () => updateRulesFromCheckboxes(deferRuleOptions, deferRulesInput));

        htmlReplacePresets.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const findValue = e.target.dataset.find;
                const replaceValue = e.target.dataset.replace;

                htmlFindInput.value = findValue;
                htmlReplaceInput.value = replaceValue;
            }
        });
        // --- End Rule Preset Logic ---

        runTestBtn.addEventListener('click', async () => {
            let url = urlSelect.value;
            if (url === 'custom') {
                url = urlInput.value;
            }

            if (!url || !url.startsWith('http')) {
                alert('Please enter a valid URL (e.g., https://example.com)');
                return;
            }

            const mode = modeSelect.value;

            // Collect and parse rules
            const blockRules = blockRulesInput.value.split(',')
                .map(s => s.trim())
                .filter(s => s.length > 0);
            const deferRules = deferRulesInput.value.split(',')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            const rules = {
                block: blockRules,
                defer: deferRules
            };

            const htmlFindRule = htmlFindInput.value;
            if (htmlFindRule) {
                rules.html_replace = { find: htmlFindRule, replace: htmlReplaceInput.value };
            }

            // Reset UI
            runTestBtn.disabled = true;
            runTestBtn.textContent = 'Testing...';
            statusEl.textContent = `Testing ${url} in ${mode} mode...`;
            metricsContainer.style.display = 'none';
            screenshotEl.style.display = 'none';
            metricsContainer.innerHTML = '';

            try {
                const response = await fetch('/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        mode: mode,
                        rules: rules
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || `Server responded with status ${response.status}`);
                }

                const data = await response.json();

                statusEl.textContent = 'Test complete!';
                metricsContainer.style.display = 'block';
                metricsContainer.innerHTML = `
                    <div class="metrics">
                        <p><strong>Mode:</strong> ${data.metrics.mode}</p>
                        <p><strong>FCP:</strong> ${data.metrics.FCP ? data.metrics.FCP.toFixed(2) + ' ms' : 'N/A'}</p>
                        <p><strong>LCP:</strong> ${data.metrics.LCP ? data.metrics.LCP.toFixed(2) + ' ms' : 'N/A'}</p>
                    </div>
                `;

                if (data.screenshot) {
                    screenshotEl.src = `data:image/png;base64,${data.screenshot}`;
                    screenshotEl.style.display = 'block';
                }

            } catch (error) {
                console.error('Test failed:', error);
                statusEl.innerHTML = `<span class="error">Test Failed: ${error.message}</span>`;
            } finally {
                runTestBtn.disabled = false;
                runTestBtn.textContent = 'Run Test';
            }
        });
    </script>

</body>
</html>