<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Performance Experiment Tool</title>
    <!-- Using Tailwind CSS for styling from a CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A simple spinning loader animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Website Performance Experiment Tool</h1>
            <p class="text-gray-600 mt-2">Test how blocking scripts, deferring assets, or changing HTML affects your site's performance.</p>
        </header>

        <main class="bg-white rounded-lg shadow-xl p-6 md:p-8 max-w-4xl mx-auto">
            <!-- Input Form -->
            <form id="test-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column: URL and Rules -->
                <div class="space-y-4">
                    <div>
                        <label for="url" class="block text-sm font-medium text-gray-700">Website URL</label>
                        <input type="url" id="url" name="url" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://example.com" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Test Mode</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="testMode" value="custom" class="form-radio" checked>
                                <span class="ml-2">Custom</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="testMode" value="pagespeed-desktop" class="form-radio">
                                <span class="ml-2">Desktop (PageSpeed)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="testMode" value="pagespeed-mobile" class="form-radio">
                                <span class="ml-2">Mobile (PageSpeed)</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="rules" class="block text-sm font-medium text-gray-700">Experiment Rules (in JSON format)</label>
                        <textarea id="rules" name="rules" rows="12" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm"></textarea>
                    </div>
                </div>

                <!-- Right Column: Instructions -->
                <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                    <h3 class="font-semibold text-gray-800 mb-2">How to Define Rules</h3>
                    <p class="text-sm text-gray-600 mb-4">Use the JSON format to specify your modifications. Here are the available keys:</p>
                    <ul class="text-xs text-gray-500 space-y-2 list-disc list-inside">
                        <li><strong class="text-gray-700">"block"</strong>: An array of strings. Any script/style URL containing one of these strings will be blocked.</li>
                        <li><strong class="text-gray-700">"defer"</strong>: An array of strings. Any script URL containing one of these strings will have the `defer` attribute added.</li>
                        <li><strong class="text-gray-700">"html_replace"</strong>: An object with "find" and "replace" keys to perform a simple text replacement on the HTML body.</li>
                    </ul>
                    <p class="text-xs text-gray-600 mt-4">See the pre-filled example for a quick start.</p>
                </div>

                <div class="md:col-span-2 text-center mt-4">
                    <button type="submit" id="run-test-btn" class="w-full md:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Run Test
                    </button>
                </div>
            </form>
            
            <!-- Loading and Error State -->
            <div id="loading" class="text-center my-8 hidden">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-600">Running test... This may take up to 30 seconds.</p>
            </div>
            <div id="error" class="text-center my-8 hidden p-4 bg-red-100 text-red-700 rounded-md"></div>

            <!-- Results Section -->
            <div id="results" class="mt-10 border-t pt-8 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Experiment Results</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Metrics -->
                    <div>
                        <h3 class="font-semibold text-lg mb-3">Key Metrics</h3>
                        <div class="bg-white rounded-lg border">
                           <table class="min-w-full divide-y divide-gray-200">
                               <thead class="bg-gray-50">
                                   <tr>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time (ms)</th>
                                   </tr>
                               </thead>
                               <tbody class="bg-white divide-y divide-gray-200">
                                   <tr>
                                       <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">First Contentful Paint (FCP)</td>
                                       <td id="fcp-result" class="px-6 py-4 whitespace-nowrap text-gray-500"></td>
                                   </tr>
                                    <tr>
                                       <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">Largest Contentful Paint (LCP)</td>
                                       <td id="lcp-result" class="px-6 py-4 whitespace-nowrap text-gray-500"></td>
                                   </tr>
                               </tbody>
                           </table>
                        </div>
                    </div>
                    <!-- Preview -->
                    <div>
                        <h3 class="font-semibold text-lg mb-3">Visual Preview</h3>
                        <div class="border rounded-lg overflow-hidden shadow">
                             <img id="screenshot-result" src="" alt="Website Screenshot" class="w-full">
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const form = document.getElementById('test-form');
        const runBtn = document.getElementById('run-test-btn');
        const urlInput = document.getElementById('url');
        const rulesInput = document.getElementById('rules');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const resultsDiv = document.getElementById('results');
        const fcpResult = document.getElementById('fcp-result');
        const lcpResult = document.getElementById('lcp-result');
        const screenshotResult = document.getElementById('screenshot-result');

        // Pre-fill the rules textarea with a helpful example
        rulesInput.value = JSON.stringify({
            "block": [
                "analytics.js",
                "some-ads-script.js"
            ],
            "defer": [
                "jquery.min.js"
            ],
            "html_replace": {
                "find": "",
                "replace": ""
            }
        }, null, 4);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const url = urlInput.value;
            const selectedMode = document.querySelector('input[name="testMode"]:checked').value;
            let rules;

            // Validate JSON
            try {
                rules = JSON.parse(rulesInput.value);
            } catch (err) {
                showError('Invalid JSON in rules. Please check the syntax.');
                return;
            }

            // UI state updates
            runBtn.disabled = true;
            runBtn.textContent = 'Testing...';
            loadingDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');

            try {
                const response = await fetch('/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, rules, mode: selectedMode })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Something went wrong on the server.');
                }
                
                const data = await response.json();
                displayResults(data);

            } catch (err) {
                showError(err.message);
            } finally {
                // Restore UI state
                runBtn.disabled = false;
                runBtn.textContent = 'Run Test';
                loadingDiv.classList.add('hidden');
            }
        });

        function displayResults({ metrics, screenshot }) {
            fcpResult.textContent = metrics.FCP ? Math.round(metrics.FCP) : 'N/A';
            lcpResult.textContent = metrics.LCP ? Math.round(metrics.LCP) : 'N/A';
            // The screenshot is sent as a base64 string, so we prepend the data URI scheme
            screenshotResult.src = `data:image/png;base64,${screenshot}`;
            resultsDiv.classList.remove('hidden');
        }

        function showError(message) {
            errorDiv.textContent = `Error: ${message}`;
            errorDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>
