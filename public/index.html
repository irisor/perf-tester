<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Tester</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #f8f9fa; }
        h1, h2 { color: #212529; }
        .container { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        input[type="text"], select { width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        button { background-color: #007bff; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #results { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef; }
        #current-result { margin-bottom: 2rem; }
        #status { font-style: italic; color: #6c757d; }
        .metrics { background: #e9f5ff; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .metrics p { margin: 0.5rem 0; }
        .metrics strong { min-width: 100px; display: inline-block; }
        #screenshot { max-width: 100%; border: 1px solid #dee2e6; border-radius: 4px; margin-top: 1rem; }
        .rules-section { margin-bottom: 2rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef; }
        .rule-options { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 0.75rem; }
        .rule-options fieldset { border: 1px solid #dee2e6; border-radius: 4px; padding: 0.5rem 1rem; }
        .rule-options legend { font-weight: 600; font-size: 0.9em; padding: 0 0.5em; }
        .rule-options label { display: block; font-weight: normal; margin-bottom: 0.25rem; }
        .rules-section h2 { margin-top: 0; }
        .rule-group { display: flex; gap: 1rem; }
        .error { color: #dc3545; font-weight: bold; }
        .preset-actions { margin-top: 1rem; }
        .preset-actions fieldset { border: 1px solid #dee2e6; border-radius: 4px; padding: 0.75rem 1rem; }
        .preset-actions legend { font-weight: 600; font-size: 0.9em; padding: 0 0.5em; }
        .preset-actions button {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.375rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .preset-actions button:hover { background-color: #dee2e6; border-color: #b1b9c1; }
        #history-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        #history-table th, #history-table td { text-align: left; padding: 0.75rem; border-bottom: 1px solid #dee2e6; }
        #history-table th { background-color: #f8f9fa; }
        #history-table tr:hover { background-color: #f1f3f5; }
        .summary-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .comparison-view { display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef; }
        .comparison-item { flex: 1; background: #f8f9fa; padding: 1rem; border-radius: 4px; border: 1px solid #e9ecef; }
        .options-group { display: flex; gap: 2rem; margin-bottom: 1.5rem; }
        .options-group .form-group { margin-bottom: 0; }
        #history-controls { margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; }
        #history-controls button { background-color: #6c757d; }
        #history-controls button:hover { background-color: #5a6268; }
        .table-container {
            overflow-x: auto; /* Enable horizontal scrolling for the table */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .preset-actions button:hover { background-color: #dee2e6; border-color: #b1b9c1; }
        .history-note {
            font-size: 0.9em;
            color: #495057;
            background-color: #e9ecef;
            padding: 0.75rem 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .naming-section {
            background-color: #f0f8ff; /* AliceBlue */
            border: 1px solid #d6eaff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .naming-section .form-group {
            margin-bottom: 0;
        }
        .spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: -0.15em;
            border: .2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
            margin-right: 0.5rem;
        }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h1>Performance Tester</h1>

        <div class="form-group">
            <label for="url-select">Select a predefined site or choose 'Custom'</label>
            <select id="url-select">
                <option value="https://www.theguardian.com/">The Guardian https://www.theguardian.com/</option>
                <option value="https://plaxidityx.com/">PlaxidityX https://plaxidityx.com/</option>
                <option value="https://example.com/">Example.com https://example.com/</option>
                <option value="custom" selected>Custom URL</option>
            </select>
        </div>

        <div class="form-group" id="custom-url-group" style="display: block;">
            <label for="url-input">Enter Custom URL</label>
            <input type="text" id="url-input" placeholder="https://your-site.com">
        </div>

        <div class="options-group">
            <div class="form-group">
                <label for="mode-select">Test Mode</label>
                <select id="mode-select">
                    <option value="pagespeed-mobile">PageSpeed Mobile</option>
                    <option value="pagespeed-desktop">PageSpeed Desktop</option>
                    <option value="custom" selected>Custom (Default)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="runs-select">Number of Runs</label>
                <select id="runs-select">
                    <option value="1">1</option>
                    <option value="3" selected>3 (recommended)</option>
                    <option value="5">5</option>
                </select>
            </div>
            <label style="align-self: center; margin-top: 1rem;"><input type="checkbox" id="disable-cache-checkbox"> Disable Cache (First Load)</label>
        </div>

        <div class="rules-section">
            <h2>Advanced Rules (Optional)</h2>
            <div class="form-group">
                <label for="block-rules">Block Resources</label>
                <div class="rule-options" id="block-rule-options">
                    <fieldset>
                        <legend>Analytics</legend>
                        <label><input type="checkbox" value="googletagmanager.com"> googletagmanager.com</label>
                        <label><input type="checkbox" value="google-analytics.com"> google-analytics.com</label>
                    </fieldset>
                    <fieldset>
                        <legend>Ads</legend>
                        <label><input type="checkbox" value="doubleclick.net"> doubleclick.net</label>
                        <label><input type="checkbox" value="googlesyndication.com"> googlesyndication.com</label>
                    </fieldset>
                    <fieldset>
                        <legend>Common Types</legend>
                        <label><input type="checkbox" value=".png,.jpg,.jpeg,.gif,.svg,.webp"> All Images</label>
                        <label><input type="checkbox" value="fonts.googleapis.com,.woff2,.ttf"> Fonts</label>
                        <label><input type="checkbox" value=".css"> All CSS</label>
                    </fieldset>
                    <fieldset>
                        <legend>Libs & 3rd Parties</legend>
                        <label><input type="checkbox" value="jquery.js,jquery.min.js"> jQuery</label>
                        <label><input type="checkbox" value="jquery-migrate"> jQuery Migrate</label>
                        <label><input type="checkbox" value="cookiebot.com,uc.js"> Cookiebot</label>
                    </fieldset>
                </div>
                <input type="text" id="block-rules" placeholder="e.g., googletagmanager, .css">
                <small style="color: #6c757d;">Select presets or enter comma-separated URL fragments to block.</small>
            </div>
            <div class="form-group">
                <label for="defer-rules">Defer Scripts</label>
                <div class="rule-options" id="defer-rule-options">
                    <fieldset>
                        <legend>Analytics</legend>
                        <label><input type="checkbox" value="googletagmanager.com"> googletagmanager.com</label>
                        <label><input type="checkbox" value="google-analytics.com"> google-analytics.com</label>
                    </fieldset>
                    <fieldset>
                        <legend>Ads</legend>
                        <label><input type="checkbox" value="doubleclick.net"> doubleclick.net</label>
                        <label><input type="checkbox" value="googlesyndication.com"> googlesyndication.com</label>
                    </fieldset>
                    <fieldset>
                        <legend>Widgets</legend>
                        <label><input type="checkbox" value="intercom.io"> intercom.io</label>
                        <label><input type="checkbox" value="livechatinc.com"> livechatinc.com</label>
                        <label><input type="checkbox" value="connect.facebook.net"> connect.facebook.net</label>
                        <label><input type="checkbox" value="platform.twitter.com"> platform.twitter.com</label>
                    </fieldset>
                    <fieldset>
                        <legend>Libs & 3rd Parties</legend>
                        <label><input type="checkbox" value="jquery.js,jquery.min.js"> jQuery</label>
                        <label><input type="checkbox" value="jquery-migrate"> jQuery Migrate</label>
                        <label><input type="checkbox" value="cookiebot.com,uc.js"> Cookiebot</label>
                    </fieldset>
                </div>
                <input type="text" id="defer-rules" placeholder="e.g., analytics.js, chat-widget.js">
                <small style="color: #6c757d;">Select presets or enter comma-separated script URL fragments to defer.</small>
            </div>
            <div class="form-group">
                <label>Replace HTML Content</label>
                <div class="rule-group">
                    <input type="text" id="html-find-rule" placeholder="Find (supports regex)">
                    <input type="text" id="html-replace-rule" placeholder="Replace with">
                </div>
                <small style="color: #6c757d;">The 'Find' field is treated as a global regular expression. For example, to remove all `<img>` tags, use `&lt;img[^>]*&gt;` in 'Find' and leave 'Replace' empty.</small>
                <div class="preset-actions" id="html-replace-presets">
                    <fieldset>
                        <legend>WP Rocket Presets</legend>
                        <!-- Note: Quotes within data attributes are HTML-escaped as &quot; -->
                        <button type="button" data-find="media='print' onload=&quot;this.media='all'&quot;" data-replace="media='all'">Disable RUCSS</button>
                        <button type="button" data-find="type=&quot;text/rocketscript&quot;" data-replace="type=&quot;text/javascript&quot;">Disable JS Delay</button>
                        <button type="button" data-find="&lt;iframe([^&gt;]*)data-src=&quot;([^&quot;]+)&quot;" data-replace="&lt;iframe$1src=&quot;$2&quot;">Disable iFrame LazyLoad</button>
                        <button type="button" data-find="&lt;style id=&quot;wpr-usedcss&quot;&gt;[^&lt;]*&lt;/style&gt;" data-replace="">Remove Used CSS Block</button>
                    </fieldset>
                </div>
            </div>
        </div>

        <div class="naming-section">
             <div class="form-group">
                <label for="test-name-input">Name Your Test (Optional)</label>
                <input type="text" id="test-name-input" placeholder="e.g., Baseline, After Optimization, No Cookiebot">
                <small style="color: #6c757d;">Give this test a memorable name to easily identify it in the history.</small>
            </div>
        </div>

        <button id="run-test">Run Test</button>

        <div id="results">
            <div id="current-result">
                <h2>Current Result</h2>
                <p id="status">Awaiting test...</p>
                <div id="metrics-container" style="display: none;"></div>
                <img id="screenshot" style="display: none;" />
            </div>

            <div id="comparison-container" style="display: none;">
                 <h2>Comparison</h2>
                 <div id="comparison-view" class="comparison-view"></div>
            </div>

            <div id="history-container">
                <h2>Test History</h2>
                <p class="history-note">
                    <strong>Note:</strong> Your test history is saved in this browser's local storage. It will be lost if you clear your browser data. For permanent storage, please use the <strong>Export to CSV</strong> button.
                </p>
                <div id="history-controls">
                    <div>
                        <button id="compare-btn">Compare Selected</button>
                        <button id="clear-history-btn">Clear History</button>
                        <button id="export-csv-btn">Export to CSV</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="history-table">
                        <thead><tr><th></th><th>Name / URL</th><th>Mode</th><th>Cache</th><th>Rules</th><th>Avg FCP (ms)</th><th>Avg LCP (ms)</th></tr></thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlSelect = document.getElementById('url-select');
        const customUrlGroup = document.getElementById('custom-url-group');
        const urlInput = document.getElementById('url-input');
        const modeSelect = document.getElementById('mode-select');
        const runsSelect = document.getElementById('runs-select');
        const disableCacheCheckbox = document.getElementById('disable-cache-checkbox');
        const blockRulesInput = document.getElementById('block-rules');
        const deferRulesInput = document.getElementById('defer-rules');
        const htmlFindInput = document.getElementById('html-find-rule');
        const htmlReplaceInput = document.getElementById('html-replace-rule');
        const testNameInput = document.getElementById('test-name-input');
        const runTestBtn = document.getElementById('run-test');
        const statusEl = document.getElementById('status');
        const metricsContainer = document.getElementById('metrics-container');
        const screenshotEl = document.getElementById('screenshot');
        const blockRuleOptions = document.getElementById('block-rule-options');
        const deferRuleOptions = document.getElementById('defer-rule-options');
        const htmlReplacePresets = document.getElementById('html-replace-presets');
        const historyBody = document.getElementById('history-body');
        const compareBtn = document.getElementById('compare-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const comparisonContainer = document.getElementById('comparison-container');
        const comparisonView = document.getElementById('comparison-view');


        urlSelect.addEventListener('change', () => {
            if (urlSelect.value === 'custom') {
                customUrlGroup.style.display = 'block';
            } else {
                customUrlGroup.style.display = 'none';
            }
        });

        // --- History & Comparison Logic ---
        let testHistory = JSON.parse(localStorage.getItem('perfTestHistory')) || [];

        function renderHistory() {
            historyBody.innerHTML = '';
            testHistory.forEach(result => {
                // Defensive check for the new data structure.
                // This handles old history items that might be in localStorage.
                const params = result.parameters || { url: 'N/A', rules: { block: [], defer: [] }, mode: 'N/A' };
                const metrics = result.averageMetrics || { FCP: null, LCP: null };
                const displayName = result.name || params.url;

                const row = document.createElement('tr');
                let rulesSummary = 'None';
                if (params.rules) {
                    rulesSummary = [
                        ...(params.rules.block || []),
                        ...(params.rules.defer || []),
                        params.rules.html_replace ? 'HTML Replace' : ''
                    ].filter(Boolean).join(', ');
                }

                row.innerHTML = `
                    <td><input type="checkbox" class="compare-checkbox" data-id="${result.id}"></td>
                    <td><div class="summary-cell" title="${displayName}">${displayName}</div></td>
                    <td>${params.mode}</td>
                    <td>${params.disableCache ? 'Disabled' : 'Enabled'}</td>
                    <td><div class="summary-cell" title="${rulesSummary || 'None'}">${rulesSummary || 'None'}</div></td>
                    <td>${metrics.FCP ? metrics.FCP.toFixed(2) : 'N/A'}</td>
                    <td>${metrics.LCP ? metrics.LCP.toFixed(2) : 'N/A'}</td>
                `;
                historyBody.appendChild(row);
            });
        }

        function saveHistory() {
            localStorage.setItem('perfTestHistory', JSON.stringify(testHistory));
        }

        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all test history?')) {
                testHistory = [];
                saveHistory();
                renderHistory();
                comparisonContainer.style.display = 'none';
            }
        });

        compareBtn.addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.compare-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length < 2) {
                alert('Please select at least two results to compare.');
                return;
            }

            const resultsToCompare = testHistory.filter(result => selectedIds.includes(result.id));
            comparisonView.innerHTML = '';

            resultsToCompare.forEach(result => {
                const item = document.createElement('div');
                item.className = 'comparison-item';
                const displayName = result.name || result.parameters.url;
                const rulesSummary = [
                    ...(result.parameters.rules.block || []),
                    ...(result.parameters.rules.defer || []),
                    result.parameters.rules.html_replace ? `HTML Find: ${result.parameters.rules.html_replace.find}` : ''
                ].filter(Boolean).join(', ');

                item.innerHTML = `
                    <h4>${displayName}</h4>
                    <p><small>URL: ${result.parameters.url}</small></p>
                    <p><strong>Mode:</strong> ${result.parameters.mode} ${result.parameters.disableCache ? '(No Cache)' : ''}</p>
                    <p><strong>Avg FCP:</strong> ${result.averageMetrics.FCP ? result.averageMetrics.FCP.toFixed(2) + ' ms' : 'N/A'}</p>
                    <p><strong>Avg LCP:</strong> ${result.averageMetrics.LCP ? result.averageMetrics.LCP.toFixed(2) + ' ms' : 'N/A'}</p>
                    <p><small><strong>Rules:</strong> ${rulesSummary || 'None'}</small></p>
                `;
                comparisonView.appendChild(item);
            });
            comparisonContainer.style.display = 'block';
            comparisonContainer.scrollIntoView({ behavior: 'smooth' });
        });

        exportCsvBtn.addEventListener('click', () => {
            if (testHistory.length === 0) {
                alert('No history to export.');
                return;
            }

            // --- 1. Collect all unique rule and run columns ---
            const ruleColumns = new Set();
            let maxRuns = 0;
            testHistory.forEach(result => {
                const rules = result.parameters?.rules || {};
                (rules.block || []).forEach(rule => ruleColumns.add(`block_${rule}`));
                (rules.defer || []).forEach(rule => ruleColumns.add(`defer_${rule}`));
                if (rules.html_replace) {
                    ruleColumns.add('html_replace_find');
                    ruleColumns.add('html_replace_replace');
                }
                if (result.individualRuns?.length > maxRuns) {
                    maxRuns = result.individualRuns.length;
                }
            });

            const sortedRuleColumns = Array.from(ruleColumns).sort();
            const runColumns = [];
            for (let i = 1; i <= maxRuns; i++) {
                runColumns.push(`Run ${i} FCP`);
                runColumns.push(`Run ${i} LCP`);
            }

            // --- 2. Build CSV Header ---
            const header = [
                'Test Name', 'URL', 'Mode', 'Cache Disabled',
                'Avg FCP', 'Avg LCP',
                ...sortedRuleColumns,
                ...runColumns
            ];

            // --- 3. Build CSV Rows ---
            const rows = testHistory.map(result => {
                const params = result.parameters || {};
                const metrics = result.averageMetrics || {};
                const rules = params.rules || {};

                const row = {
                    'Test Name': result.name || '',
                    'URL': params.url || 'N/A',
                    'Mode': params.mode || 'N/A',
                    'Cache Disabled': params.disableCache ? '1' : '0',
                    'Avg FCP': metrics.FCP?.toFixed(2) || '',
                    'Avg LCP': metrics.LCP?.toFixed(2) || '',
                };

                // Populate rule columns
                sortedRuleColumns.forEach(col => {
                    if (col.startsWith('block_')) {
                        row[col] = (rules.block || []).includes(col.replace('block_', '')) ? '1' : '0';
                    } else if (col.startsWith('defer_')) {
                        row[col] = (rules.defer || []).includes(col.replace('defer_', '')) ? '1' : '0';
                    } else if (col === 'html_replace_find') {
                        row[col] = rules.html_replace?.find || '';
                    } else if (col === 'html_replace_replace') {
                        row[col] = rules.html_replace?.replace || '';
                    }
                });

                // Populate individual run columns
                for (let i = 0; i < maxRuns; i++) {
                    const run = result.individualRuns?.[i];
                    row[`Run ${i + 1} FCP`] = run?.FCP?.toFixed(2) || '';
                    row[`Run ${i + 1} LCP`] = run?.LCP?.toFixed(2) || '';
                }

                return header.map(h => `"${(row[h] ?? '').toString().replace(/"/g, '""')}"`).join(',');
            });

            // --- 4. Create and Download CSV File ---
            const csvContent = [header.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `perf-test-history-${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        });

        document.addEventListener('DOMContentLoaded', renderHistory);

        // --- Rule Preset Logic ---
        function updateRulesFromCheckboxes(optionsContainer, inputElement) {
            const checkedOptions = Array.from(optionsContainer.querySelectorAll('input:checked'));
            const presetValues = new Set();

            // Get all values from checked boxes. A value can be a comma-separated list.
            checkedOptions.forEach(checkbox => {
                checkbox.value.split(',').forEach(val => {
                    if (val.trim()) presetValues.add(val.trim());
                });
            });

            // Get all currently known preset values to help identify custom ones.
            const allPresetValues = new Set();
            optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.value.split(',').forEach(val => {
                    if (val.trim()) allPresetValues.add(val.trim());
                });
            });

            // Preserve custom values that the user may have typed manually.
            const currentInputValues = inputElement.value.split(',').map(s => s.trim()).filter(Boolean);
            const customValues = currentInputValues.filter(val => !allPresetValues.has(val));

            const finalValues = new Set([...presetValues, ...customValues]);
            inputElement.value = Array.from(finalValues).join(', ');
        }

        blockRuleOptions.addEventListener('change', () => updateRulesFromCheckboxes(blockRuleOptions, blockRulesInput));
        deferRuleOptions.addEventListener('change', () => updateRulesFromCheckboxes(deferRuleOptions, deferRulesInput));

        htmlReplacePresets.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const findValue = e.target.dataset.find;
                const replaceValue = e.target.dataset.replace;

                htmlFindInput.value = findValue;
                htmlReplaceInput.value = replaceValue;
            }
        });
        // --- End Rule Preset Logic ---

        runTestBtn.addEventListener('click', async () => {
            let url = urlSelect.value;
            if (url === 'custom') {
                url = urlInput.value;
            }

            if (!url || !url.startsWith('http')) {
                alert('Please enter a valid URL (e.g., https://example.com)');
                return;
            }

            const mode = modeSelect.value;
            const runs = parseInt(runsSelect.value, 10);
            const disableCache = disableCacheCheckbox.checked;
            const testName = testNameInput.value.trim();

            // Collect and parse rules
            const blockRules = blockRulesInput.value.split(',')
                .map(s => s.trim())
                .filter(s => s.length > 0);
            const deferRules = deferRulesInput.value.split(',')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            const rules = {
                block: blockRules,
                defer: deferRules
            };

            const htmlFindRule = htmlFindInput.value;
            if (htmlFindRule) {
                rules.html_replace = { find: htmlFindRule, replace: htmlReplaceInput.value };
            }

            // Reset UI
            runTestBtn.disabled = true;
            runTestBtn.innerHTML = '<span class="spinner"></span>Testing...';
            statusEl.textContent = `Testing ${url} (${runs}x runs, Cache: ${disableCache ? 'Off' : 'On'})...`;
            metricsContainer.style.display = 'none';
            screenshotEl.style.display = 'none';
            metricsContainer.innerHTML = '';

            try {
                const response = await fetch('/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        mode: mode,
                        rules: rules,
                        runs: runs,
                        disableCache: disableCache
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || `Server responded with status ${response.status}`);
                }

                const data = await response.json();

                // Add result to history
                const resultRecord = {
                    id: `test-${Date.now()}`,
                    name: testName,
                    parameters: data.parameters,
                    averageMetrics: data.averageMetrics,
                    individualRuns: data.individualRuns
                };
                testHistory.unshift(resultRecord); // Add to the beginning
                saveHistory();
                renderHistory();

                statusEl.textContent = 'Test complete!';
                metricsContainer.style.display = 'block';
                const runsDetails = data.individualRuns.map((run, i) => `Run ${i+1}: FCP ${run.FCP.toFixed(0)} / LCP ${run.LCP.toFixed(0)}`).join(' | ');
                metricsContainer.innerHTML = `
                    <div class="metrics">
                        <p><strong>Mode:</strong> ${data.parameters.mode}</p>
                        <p><strong>Avg FCP:</strong> ${data.averageMetrics.FCP ? data.averageMetrics.FCP.toFixed(2) + ' ms' : 'N/A'}</p>
                        <p><strong>Avg LCP:</strong> ${data.averageMetrics.LCP ? data.averageMetrics.LCP.toFixed(2) + ' ms' : 'N/A'}</p>
                        <p><small>${runsDetails}</small></p>
                    </div>
                `;

                if (data.screenshot) {
                    screenshotEl.src = `data:image/png;base64,${data.screenshot}`;
                    screenshotEl.style.display = 'block';
                }

            } catch (error) {
                console.error('Test failed:', error);
                statusEl.innerHTML = `<span class="error">Test Failed: ${error.message}</span>`;
            } finally {
                runTestBtn.disabled = false;
                runTestBtn.textContent = 'Run Test';
            }
        });
    </script>


</body>
</html>